<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Inversioin using Automatic Differentiation · ADSeismic.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="ADSeismic.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ADSeismic.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Getting Started</a></li><li><a class="tocitem" href="../ad/">Inverse Modeling</a></li><li><a class="tocitem" href="../forward_simulation/">Forward Simulation</a></li><li class="is-active"><a class="tocitem" href>Inversioin using Automatic Differentiation</a><ul class="internal"><li><a class="tocitem" href="#Inverting-Velocity-Model"><span>Inverting Velocity Model</span></a></li><li><a class="tocitem" href="#Inverting-Source-Location-and-Time-Function"><span>Inverting Source Location and Time Function</span></a></li><li><a class="tocitem" href="#Inverting-Rupture-Process"><span>Inverting Rupture Process</span></a></li></ul></li><li><a class="tocitem" href="../NNFWI/">NNFWI</a></li><li><a class="tocitem" href="../contents/">Script Reference</a></li><li><a class="tocitem" href="../api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Inversioin using Automatic Differentiation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Inversioin using Automatic Differentiation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/kailaix/ADSeismic.jl/blob/master/docs/src/backward_inversion.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Inversioin-using-Automatic-Differentiation"><a class="docs-heading-anchor" href="#Inversioin-using-Automatic-Differentiation">Inversioin using Automatic Differentiation</a><a id="Inversioin-using-Automatic-Differentiation-1"></a><a class="docs-heading-anchor-permalink" href="#Inversioin-using-Automatic-Differentiation" title="Permalink"></a></h1><p>In this section, we describe three inversion problems in seismic imaging: inverting velocity, inverting source location and time function, and inverting rupture process. </p><p>Despite the method described here is also applicable to elastic wave equation, we consider the simpler the acoustic wave equation <span>$\begin{aligned} {u_{tt}} - {c^2}\Delta u =&amp; f \\ u =&amp; {u_0} \\ {u_t} =&amp; {v_0} \end{aligned}$</span></p><p>Here <span>$f$</span> is the source function, <span>$u_0$</span> and <span>$v_0$</span> are initial conditions. For numerical simulation, the perfect matched layer boundary condition is used to truncate the computational domain. See <a href="https://kailaix.github.io/ADSeismic.jl/dev/forward_simulation/#Acoustic-Wave-Simulation-1">Acoustic Wave Simulation</a> for details. </p><h2 id="Inverting-Velocity-Model"><a class="docs-heading-anchor" href="#Inverting-Velocity-Model">Inverting Velocity Model</a><a id="Inverting-Velocity-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Inverting-Velocity-Model" title="Permalink"></a></h2><p>In this model, <span>$c(x, y)$</span> is unknown. Red dots represent <span>$n$</span> sources and triangles represent <span>$m$</span> receivers at locations <span>$\{\mathbf{x}_i\}$</span>. We activate the sources one by one and collect the time serious signals <span>$u(t, \mathbf{x}_i)$</span> at the receivers for different source functions. Therefore, the observations are <span>$m$</span> <span>$\mathbb{R}^{n_t\times n}$</span> matrices, where <span>$n_t$</span> is the size of the time series. This inversion problem is called <strong>full waveform inversion</strong>, or FWI for short. </p><p>The idea of FWI is updating <span>$c(x, y)$</span> until the observations and the estimations–which are obtained from solving the wave equation–match. We do benchmarks on two classical models for <span>$c(x,y)$</span>: Marmousi model and Layer model. </p><h3 id="Marmousi-model"><a class="docs-heading-anchor" href="#Marmousi-model">Marmousi model</a><a id="Marmousi-model-1"></a><a class="docs-heading-anchor-permalink" href="#Marmousi-model" title="Permalink"></a></h3><p><img src="../asset/forward_marmousi.gif" alt/></p><table><tr><th style="text-align: right">Ground Truth</th><th style="text-align: right">Inversion</th></tr><tr><td style="text-align: right"><img src="../asset/marmousi-model-vp.png" alt/></td><td style="text-align: right"><img src="../asset/fwi_marmousi.png" alt/></td></tr></table><p><img src="../asset/fwi_marmousi.gif" alt/></p><h3 id="Layer-model"><a class="docs-heading-anchor" href="#Layer-model">Layer model</a><a id="Layer-model-1"></a><a class="docs-heading-anchor-permalink" href="#Layer-model" title="Permalink"></a></h3><p><img src="../asset/forward_layermodel.gif" alt/></p><table><tr><th style="text-align: right">Ground Truth</th><th style="text-align: right">Inversion</th></tr><tr><td style="text-align: right"><img src="../asset/layer-model-vp.png" alt/></td><td style="text-align: right"><img src="../asset/fwi_layermodel.png" alt/></td></tr></table><p><img src="../asset/fwi_layermodel.gif" alt/></p><p>To invert the acoustic wave velocity, we first create three containers for storing simulation results, source functions and receiver data</p><pre><code class="language-julia hljs">ap_sim = load_acoustic_model(&quot;models/layer-model-smooth.mat&quot;; inv_vp=true, IT_DISPLAY=0)
src = load_acoustic_source(&quot;models/layer-model-smooth.mat&quot;)
rcv_sim = load_acoustic_receiver(&quot;models/layer-model-smooth.mat&quot;)</code></pre><p>Then we load ground truth receiver data</p><pre><code class="language-julia hljs">Rs = Array{Array{Float64,2}}(undef, length(src))
for i = 1:length(src)
    Rs[i] = readdlm(joinpath(output_dir, &quot;layermodel-r$i.txt&quot;))
end</code></pre><p>Since we want to run the model on multi-GPU, we instruct ADSeismic to compute the gradients and loss on GPUs and then assemble them on CPU</p><pre><code class="language-julia hljs">vp = get_collection()[1]
losses, gs = compute_loss_and_grads_GPU(ap_sim, src, rcv_sim, Rs, vp) # losses and gs are computed on GPUs
g = sum(gs); loss = sum(losses) # g and loss are assembled on CPU</code></pre><p>Finally, the optimization can be triggered by <code>LBFGS!</code>, a built-in L-BFGS optimizer</p><pre><code class="language-julia hljs">sess = Session(); init(sess)
LBFGS!(sess, loss, g, vp)</code></pre><h2 id="Inverting-Source-Location-and-Time-Function"><a class="docs-heading-anchor" href="#Inverting-Source-Location-and-Time-Function">Inverting Source Location and Time Function</a><a id="Inverting-Source-Location-and-Time-Function-1"></a><a class="docs-heading-anchor-permalink" href="#Inverting-Source-Location-and-Time-Function" title="Permalink"></a></h2><p>In this case, the location and amplitude function of the source (we assume there is one single source) is not known. The receivers are placed on the earth surface. We want to estimate the source term <span>$f$</span> based on the receiver information (which are <span>$m$</span> time series in <span>$\mathbb{R}^{n_t}$</span>).</p><p>Mathematically, <span>$f(t, \mathbf{x})$</span> is a Delta function in <span>$\mathbf{x}$</span>; to make the inversion problem continuous, we use </p><p class="math-container">\[f_{\theta}(t, \mathbf{x}) = g(t) \frac{1}{2\pi\sigma^2}\exp(-\frac{\|\mathbf{x}-\theta\|^2}{2\sigma^2})\]</p><p>to approximate <span>$f(t, \mathbf{x})$</span>; here <span>$\theta\in\mathbb{R}^2$</span> and <span>$g(t)$</span> are unknown. </p><table><tr><th style="text-align: right">Source/Receiver Location</th><th style="text-align: right">Forward Simulation</th></tr><tr><td style="text-align: right"><img src="../asset/source-vp.png" alt/></td><td style="text-align: right"><img src="../asset/forward_source.gif" alt/></td></tr></table><table><tr><th style="text-align: right">Source Time Function Inversion</th><th style="text-align: right">Source Location Inversion</th></tr><tr><td style="text-align: right"><img src="../asset/source-waveform.png" alt/></td><td style="text-align: right"><img src="../asset/source-location.png" alt/></td></tr></table><p><img src="../asset/fwi_source.gif" alt/></p><h2 id="Inverting-Rupture-Process"><a class="docs-heading-anchor" href="#Inverting-Rupture-Process">Inverting Rupture Process</a><a id="Inverting-Rupture-Process-1"></a><a class="docs-heading-anchor-permalink" href="#Inverting-Rupture-Process" title="Permalink"></a></h2><h3 id=".-Invert-the-rupture-process-directly"><a class="docs-heading-anchor" href="#.-Invert-the-rupture-process-directly">1. Invert the rupture process directly</a><a id=".-Invert-the-rupture-process-directly-1"></a><a class="docs-heading-anchor-permalink" href="#.-Invert-the-rupture-process-directly" title="Permalink"></a></h3><table><tr><th style="text-align: right">Source/Receiver Location</th><th style="text-align: right">Forward Simulation</th></tr><tr><td style="text-align: right"><img src="../asset/rupture-vp.png" alt/></td><td style="text-align: right"><img src="../asset/forward_rupture.gif" alt/></td></tr></table><table><tr><th style="text-align: right">Ground Truth</th><th style="text-align: right">Inversion</th></tr><tr><td style="text-align: right"><img src="../asset/rupture-waveform.png" alt/></td><td style="text-align: right"><img src="../asset/fwi_rupture.png" alt/></td></tr></table><p><img src="../asset/fwi_rupture.gif" alt/></p><h3 id=".-Inverte-the-slip-time-and-amplitude"><a class="docs-heading-anchor" href="#.-Inverte-the-slip-time-and-amplitude">2. Inverte the slip time and amplitude</a><a id=".-Inverte-the-slip-time-and-amplitude-1"></a><a class="docs-heading-anchor-permalink" href="#.-Inverte-the-slip-time-and-amplitude" title="Permalink"></a></h3><p>In this case, the functional form of the source function is known (see <a href="@ref"><code>Gauss</code></a>)</p><p class="math-container">\[f(t) = \frac{2A}{\pi^2 a^2} \exp\left( -\frac{(t-t_0)^2}{\pi^2 a^2} \right)\]</p><p>where <span>$A$</span> is the amplitude, <span>$a$</span> is the parameter that controls width of the Gaussian, and <span>$t_0$</span> is the shift of the parameter. </p><table><tr><th style="text-align: right">Ground Truth</th><th style="text-align: right">Inversion</th></tr><tr><td style="text-align: right"><img src="../asset/rupture-waveform-time.png" alt/></td><td style="text-align: right"><img src="../asset/fwi_rupture_time.png" alt/></td></tr></table><p><img src="../asset/fwi_rupture_time.gif" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../forward_simulation/">« Forward Simulation</a><a class="docs-footer-nextpage" href="../NNFWI/">NNFWI »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Monday 27 June 2022 00:59">Monday 27 June 2022</span>. Using Julia version 1.4.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
